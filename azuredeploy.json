{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"databaseAccountName": {
			"type": "string",
			"metadata": {
				"description": "The DocumentDB database account name."
			}
		},
		"dataBase": {
			"type": "string",
			"metadata": {
				"description": "Database name"
			}
		},
		"appSvcPlanName": {
			"type": "string",
			"metadata": {
				"description": "The name of the App Service Plan that will host the Web App."
			}
		},
			"svcPlanSize": {
			"type": "string",
			"metadata": {
				"description": "The instance size of the App Service Plan."
			}
		},
			"svcPlanSku": {
			"type": "string",
			"metadata": {
				"description": "The pricing tier of the App Service plan."
			}
		},
		"apiAppName": {
			"type": "string",
			"metadata": {
				"description": "The name of the Api App."
			}
			},
		"gatewayName": {
      			"type": "string",
      			"metadata": {
        			"description": "The name of the existing gateway. The API app gets registered to this gateway."
      			}
      			},
      		"apiAppSecret": {
      			"type": "securestring",
      			"metadata": {
        			"description": "The secret for the API app. This value must be a base64-encoded string. It should be a random string with 64 characters, and consist of only integers and lowercase characters. "
      }
    }
		},
	"variables": 
	{
		"databaseAccountTier": "Standard",
		"packageId": "Microsoft.ApiApp"
	},
	"resources": [{
		"apiVersion": "2015-04-08",
		"type": "Microsoft.DocumentDb/databaseAccounts",
		"name": "[parameters('databaseAccountName')]",
		"location": "[resourceGroup().location]",
		"properties": {
			"name": "[parameters('databaseAccountName')]",
			"databaseAccountOfferType": "[variables('databaseAccountTier')]"
		}
	}, {
		"type": "Microsoft.Web/serverfarms",
		"apiVersion": "2015-08-01",
		"name": "[parameters('appSvcPlanName')]",
		"location": "[resourceGroup().location]",
			"sku": {
			"name": "[parameters('svcPlanSize')]",
			"tier": "[parameters('svcPlanSku')]",
			"capacity": 1
		}
	}, {
		"type": "Microsoft.Web/Sites",
		"apiVersion": "2015-08-01",
		"name": "[parameters('apiAppName')]",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.AppService/gateways', parameters('gatewayName'))]"
		],
		 "resources": [
                {
                    "type": "siteextensions",
                    "tags": {
                        "displayName": "APIAppExtension"
                    },
                    "apiVersion": "2015-04-01",
                    "name": "[variables('$packageId')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', parameters('apiAppName'))]"
                    ],
                    "properties": {
                        "type": "WebRoot",
                        "feed_url": "[variables('$nugetFeed')]"
                    }
                },
                {
                    "type": "providers/links",
                    "apiVersion": "2015-01-01",
                    "name": "Microsoft.Resources/apiApp",
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', parameters('apiAppName'))]"
                    ],
                    "properties": {
                        "targetId": "[resourceId('Microsoft.AppService/apiapps', parameters('apiAppName'))]"
                    }
                }
            ],
		"properties": {
			"name": "[parameters('apiAppName')]",
			 "gatewaySiteName": "[parameters('gatewayName')]",
			"serverFarmId": "[parameters('appSvcPlanName')]",
			"siteConfig": {
				"phpVersion": "off",
				"appSettings": [
						{
                            		"name": "EMA_MicroserviceId",
                            		"value": "[parameters('apiAppName')]"
                        	},
                        	{
                            		"name": "EMA_Secret",
                            		"value": "[parameters('gatewayToAPIappSecret')]"
                        	},
                        	{
                            		"name": "EMA_RuntimeUrl",
                            		"value": "[concat('https://', reference(resourceId('Microsoft.Web/sites', parameters('gatewayName'))).hostNames[0])]"
                        	},
                        	{
                            		"name": "WEBSITE_START_SCM_ON_SITE_CREATION",
                            		"value": "1"
                        	},
				{
					"Name": "endpoint",
					"Value": "[reference(concat('Microsoft.DocumentDb/databaseAccounts/', parameters('databaseAccountName'))).documentEndpoint]"
				}, {
					"Name": "authKey",
					"Value": "[listKeys(resourceId('Microsoft.DocumentDb/databaseAccounts', parameters('databaseAccountName')), '2015-04-08').primaryMasterKey]"
				},
				{
					"Name": "database",
					"Value": "[parameters('dataBase')]"
				}
				]
			}
		}
	},
	{
            "type": "Microsoft.Web/sites",
            "apiVersion": "2015-04-01",
            "name": "[parameters('apiAppName')]",
            "location": "[parameters('location')]",
            "kind": "apiApp",
            "resources": [
                {
                    "type": "siteextensions",
                    "apiVersion": "2015-02-01",
                    "name": "[variables('packageId')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', parameters('apiAppName'))]"
                    ],
                    "properties": {
                        "type": "WebRoot",
                        "feed_url": "http://apiapps-preview.nuget.org/api/v2/",
                        "version": "0.9.4"
                    }
                },
                {
                    "type": "providers/links",
                    "apiVersion": "2015-01-01",
                    "name": "Microsoft.Resources/apiApp",
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', parameters('apiAppName'))]"
                    ],
                    "properties": {
                        "targetId": "[resourceId('Microsoft.AppService/apiapps', parameters('apiAppName'))]"
                    }
                }
            ],
            "properties": {
                "name": "[parameters('apiAppName')]",
                "gatewaySiteName": "[parameters('gatewayName')]",
                "serverFarmId": "[parameters('hostingPlanId')]",
                "hostingEnvironment": "[parameters('hostingPlanSettings').hostingEnvironment]",
                "siteConfig": {
                    "appSettings": [
                        {
                            "name": "EMA_MicroserviceId",
                            "value": "[parameters('apiAppName')]"
                        },
                        {
                            "name": "EMA_Secret",
                            "value": "[parameters('apiAppSecret')]"
                        },
                        {
                            "name": "EMA_RuntimeUrl",
                            "value": "[concat('https://', parameters('gatewayName'), '.azurewebsites.net')]"
                        },
                        {
                            "name": "WEBSITE_START_SCM_ON_SITE_CREATION",
                            "value": "1"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.AppService/apiapps",
            "apiVersion": "2015-03-01-preview",
            "name": "[parameters('apiAppName')]",
            "location": "[parameters('location')]",
            "resources": [
                {
                    "type": "providers/links",
                    "apiVersion": "2015-01-01",
                    "name": "Microsoft.Resources/apiAppSite",
                    "dependsOn": [
                        "[resourceId('Microsoft.AppService/apiapps', parameters('apiAppName'))]"
                    ],
                    "properties": {
                        "targetId": "[resourceId('Microsoft.Web/sites', parameters('apiAppName'))]"
                    }
                }
            ],
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites/siteextensions', parameters('apiAppName'), variables('packageId'))]"
            ],
            "properties": {
                "package": {
                    "id": "[variables('packageId')]"
                },
                "host": {
                    "resourceName": "[parameters('apiAppName')]"
                },
                "gateway": {
                    "resourceName": "[parameters('gatewayName')]"
                }
            }
        }
	]
}
